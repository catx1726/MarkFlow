name: AI PR Summary & Guard
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate AI Summary
        id: summary
        run: |
          echo "### ğŸ¤– AI ä»£ç å˜æ›´è‡ªæ£€" > summary.md
          echo "#### 1. å˜æ›´ç»Ÿè®¡" >> summary.md
          git diff origin/${{ github.base_ref }} --stat >> summary.md

          echo -e "\n#### 2. å…³é”®æ–‡ä»¶å˜æ›´æ¸…å•" >> summary.md
          git diff origin/${{ github.base_ref }} --name-only | grep -E '\.(js|vue|ts|py|go)$' || echo "æ— æ ¸å¿ƒé€»è¾‘å˜æ›´" >> summary.md

          # æ£€æŸ¥å½’æ¡£æ–‡æ¡£åŒæ­¥çŠ¶æ€
          echo -e "\n#### 3. SOP åˆè§„æ€§æ£€æŸ¥" >> summary.md
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }} | grep '.ai/archive/')
          if [ -z "$CHANGES" ]; then
            echo "âš ï¸ **è­¦å‘Š**ï¼šæœªæ£€æµ‹åˆ° \`.ai/archive/\` ä¸‹çš„æ–¹æ¡ˆå½’æ¡£æ›´æ–°ã€‚è¯·ç¡®ä¿å·²åŒæ­¥æœ¬æ¬¡ä»»åŠ¡çš„åˆ†ææ–‡æ¡£ã€‚" >> summary.md
          else
            echo "âœ… å·²æ£€æµ‹åˆ°å½’æ¡£æ–‡æ¡£æ›´æ–°ã€‚" >> summary.md
          fi

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: summary.md
          comment_tag: ai-summary # ç¡®ä¿åç»­æ›´æ–°ä¼šè¦†ç›–æ—§è¯„è®ºè€Œéäº§ç”Ÿå¤§é‡æ–°è¯„è®º
