name: AI PR Summary & Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  summary_and_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 ç¡®ä¿èŽ·å–å®Œæ•´åŽ†å²ï¼Œä»¥ä¾¿ git diff èƒ½æ‰¾åˆ°åŸºå‡†åˆ†æ”¯
          fetch-depth: 0

      - name: Generate AI Summary
        id: summary
        run: |
          # 1. ç¡®ä¿å¯¹æ¯”åŸºå‡†å­˜åœ¨
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          
          # 2. åˆå§‹åŒ– Summary å†…å®¹
          echo "### ðŸ¤– AI ä»£ç å˜æ›´è‡ªæ£€" > summary.md
          echo "#### 1. å˜æ›´ç»Ÿè®¡ (Stat)" >> summary.md
          echo "\`\`\`text" >> summary.md
          git diff origin/${{ github.base_ref }}...HEAD --stat >> summary.md
          echo "\`\`\`" >> summary.md
          
          echo -e "\n#### 2. å…³é”®æ–‡ä»¶å˜æ›´æ¸…å•" >> summary.md
          # æŽ’é™¤éžä¸šåŠ¡é€»è¾‘ç›®å½•ï¼Œä¿ç•™ src ä¸‹çš„æ ¸å¿ƒé€»è¾‘
          FILES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -vE '^(\.ai/|\.github/|package\.json|pnpm-lock\.yaml|README\.md)' || true)
          
          if [ -z "$FILES" ]; then
            echo "_æ— æ ¸å¿ƒé€»è¾‘æ–‡ä»¶å˜æ›´_" >> summary.md
          else
            # é€è¡Œæ ¼å¼åŒ–ä¸º Markdown åˆ—è¡¨
            echo "$FILES" | while read -r line; do echo "- \`$line\`"; done >> summary.md
          fi
          
          echo -e "\n#### 3. SOP åˆè§„æ€§æ£€æŸ¥" >> summary.md
          # æ£€æŸ¥ .ai/archive/ ä¸‹æ˜¯å¦æœ‰å¯¹åº”æœ¬æ¬¡ä»»åŠ¡çš„æ–‡æ¡£æ›´æ–°
          ARCHIVE_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep '.ai/archive/' || true)
          if [ -z "$ARCHIVE_CHANGES" ]; then
            echo "âŒ **å¼‚å¸¸**ï¼šæœªæ£€æµ‹åˆ° \`.ai/archive/\` ä¸‹çš„å½’æ¡£æ–‡æ¡£ã€‚è¯·ç¡®ä¿å·²åŒæ­¥æœ¬æ¬¡ä»»åŠ¡çš„æ€»ç»“æ–‡ä»¶ã€‚" >> summary.md
            echo "CHECK_STATUS=fail" >> $GITHUB_ENV
          else
            echo "âœ… **åˆè§„**ï¼šå·²æ£€æµ‹åˆ°å½’æ¡£æ–‡æ¡£æ›´æ–°ï¼š" >> summary.md
            echo "$ARCHIVE_CHANGES" | while read -r line; do echo "- \`$line\`"; done >> summary.md
            echo "CHECK_STATUS=pass" >> $GITHUB_ENV
          fi

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: summary.md
          comment_tag: ai_summary_guard

      - name: Final Check Guard
        if: env.CHECK_STATUS == 'fail'
        run: |
          echo "SOP check failed: Missing archive documentation."
          exit 1
